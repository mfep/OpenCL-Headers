name: Release

on:
  push:
    tags:
    - "*"

env:
  PACKAGE_NAME: opencl-c-headers
  PACKAGE_DESCRIPTION: OpenCL (Open Computing Language) C header files

jobs:
  release:
    runs-on: ubuntu-latest
    container: streamhpc/opencl-sdk-base:ubuntu-22.04-20230717
    steps:
    - name: Install prerequisites
      shell: bash
      run: apt-get update -qq && apt-get install -y cmake devscripts

    - name: Import GPG signing key
      shell: bash
      run: echo "${{ secrets.DEB_SIGNING_KEY }}" | gpg --import

    - name: Download source code
      shell: bash
      run: wget -O $GITHUB_WORKSPACE/../${{ env.PACKAGE_NAME }}_$GITHUB_REF_NAME.orig.tar.gz https://github.com/$GITHUB_REPOSITORY/archive/refs/tags/$GITHUB_REF_NAME.tar.gz

    - name: Assemble Debian packaging files
      shell: bash
      run: |2
        mkdir debian
        echo "Source: opencl-c-headers
        Section: devel
        Priority: optional
        Maintainer: ${{ vars.DEB_MAINTAINER }}"
        Build-Depends: cmake, build-essential
        Homepage: https://github.com/KhronosGroup/OpenCL-Headers

        Package: opencl-c-headers
        Architecture: any
        Description: ${{ env.PACKAGE_DESCRIPTION }}" > ./debian/control

        echo "opencl-c-headers ($GITHUB_REF_NAME-0ppa0) jammy; urgency=low
        
          * Released version $GITHUB_REF_NAME

         -- ${{ vars.DEB_MAINTAINER }}  $(date -R)" > ./debian/changelog

        echo "#!/usr/bin/make -f
        BUILDDIR = build_dir
        build:
        	mkdir \$(BUILDDIR);
        	cd \$(BUILDDIR); cmake -DCMAKE_INSTALL_PREFIX=../debian/tmp/usr ..
        	make -C \$(BUILDDIR)
        binary: binary-indep binary-arch
        binary-indep:
        	# nothing to be done
        binary-arch:
        	cd \$(BUILDDIR); cmake -P cmake_install.cmake
        	mkdir debian/tmp/DEBIAN
        	dpkg-gencontrol -p${{ env.PACKAGE_NAME }}
        	dpkg --build debian/tmp ..
        clean:
        	rm -rf \$(BUILDDIR)
        .PHONY: binary binary-arch binary-indep clean" > ./debian/rules

    - name: List Debian packaging files
      shell: bash
      run: |
        cat $GITHUB_WORKSPACE/debian/control
        cat $GITHUB_WORKSPACE/debian/changelog
        cat $GITHUB_WORKSPACE/debian/rules

    - name: Build source package
      shell: bash
      run: debuild -S -sa

    - name: Push source package to the PPA
      shell: bash
      run: dput ppa:${{ vars.PPA }} $GITHUB_WORKSPACE/../${{ env.PACKAGE_NAME }}_$GITHUB_REF_NAME-0ppa0_source.changes

    - name: Create GitHub release
      uses: softprops/action-gh-release@v1
